\documentclass[10pt,letter]{book}
\usepackage[left=1in, right=1in, top=1in, bottom=1in]{geometry}
\usepackage{amsmath}
%\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{caption}
\usepackage[belowskip=0pt, aboveskip=0pt]{subcaption}
\usepackage{enumitem}
\usepackage{float}
\usepackage{url}
\usepackage{fancyhdr}

% Draw a line on each page at the top
\pagestyle{fancy}
\fancyhf{}
\fancyhead[EL]{\nouppercase\leftmark}
\fancyhead[OR]{\nouppercase\rightmark}
\fancyhead[ER,OL]{\thepage}

\newcommand{\pd}[2]{\dfrac{\partial #1}{\partial #2}}
\newcommand{\pf}[2]{\dfrac{d #1}{d #2}}
\newcommand{\pdt}[2]{\dfrac{\partial^2 #1}{\partial #2^2}}
\newcommand{\pft}[2]{\dfrac{d^2 #1}{d #2^2}}
\newcommand{\pdtno}[2]{\dfrac{\partial^2 #1}{\partial #2}}
\newcommand{\pdd}[3]{\dfrac{\partial^2 #1}{\partial #2 \partial #3}}
\newcommand{\pff}[3]{\dfrac{d^2 #1}{d #2 d #3}}

\renewcommand\floatpagefraction{0.99}
\renewcommand\topfraction{0.99}
\renewcommand\bottomfraction{0.99}
\renewcommand\textfraction{0.0}

\providecommand*\url[1]{\href{#1}{#1}}

\title{\LARGE \textbf{Time Dependent Adjoint Sensitivities for Second-Order Systems}}
\author{\textbf{Komahan Boopathy} \textit{and} \textbf{Graeme J. Kennedy}}
\date{\today}

\begin{document}
\maketitle
% \rule{\textwidth}{2pt}

% \noindent\makebox[\linewidth]{\rule{\paperwidth}{2pt}}
%\tableofcontents
% \clearpage

\part{Adjoint Sensitivities}

\chapter{Discrete Adjoint Formulations}

\section{Backwards Difference Formulae}

\section{Newmark--Beta--Gamma Method}

The second--order governing differential equations are posed in the following
descriptor form at the k$^{th}$ time step:
$$ R_k(\ddot{q}_k, \dot{q}_k, q_k, t_k , x) = 0.$$
We use Newmark--Beta--Gamma (NBG) method to approximate the states:
$$ S_k =  \dot{q}_{k-1}  + (1-\gamma) h \ddot{q}_{k-1} +  \gamma h \ddot{q}_{k}- \dot{q}_k$$ 
$$ T_k = {q}_{k-1} + h \dot{q}_{k-1} +\frac{1-2\beta}{2}
h^2\ddot{q}_{k-1}+ \beta h^2 \ddot{q}_k-{q}_k.$$ The acceleration
states $\ddot{q}_k$ are the primary unknown at each time step. We
introduce $\lambda_k$, $\psi_k$ and $\phi_k$ as adjoint variables
associated with each of these equations. The Lagrangian function is
written as:
$${\cal{L}} = \sum_{k=0}^N h f_k(\underline{\ddot{q}_k},
\dot{q}_k, q_k, x) + \sum_{k=0}^N h \lambda_k^T
R_k(\underline{\ddot{q}_k}, \dot{q}_k, q_k, x) + \sum_{k=0}^N \psi_k^T
S_k(\underline{\dot{q}_k}, \dot{q}_{k-1}, \ddot{q}_{k-1},
\ddot{q}_{k}) + \sum_{k=0}^N \phi_k^T T_k(\underline{{q}_k},
     {q}_{k-1}, \ddot{q}_{k-1}, \ddot{q}_{k}). $$     
     The underlined variables denote the primary unknown in each equation. 
     The stationary points of the Lagrangian function with respect to the state variables can be used to determine the adjoint
     variables.
     \paragraph{Solving for $\phi$:} Setting $\pd{\cal{L}}{{q}_k} = 0$ yields,
     \begin{equation}
       \begin{split}
         \phi_k = \phi_{k+1} +  h \left\{\pd{f_{k+1}}{{q}_{k+1}} \right\}^T + h \left[ \pd{R_{k+1}}{{q}_{k+1}} \right]^T \lambda_{k+1}.
       \end{split}
     \end{equation}
     \paragraph{Solving for $\psi$:} Setting $\pd{\cal{L}}{\dot{q}_k} = 0$ yields,
     \begin{equation}
       \begin{split}
         \psi_k = \psi_{k+1} + h \phi_{k+1} + h \left\{  \pd{f_{k+1}}{\dot{q}_{k+1}} +  h \pd{f_{k+1}}{{q}_{k+1}} \right\}^T 
         + h \left[ \pd{R_{k+1}}{\dot{q}_{k+1}} +  h \pd{R_{k+1}}{{q}_{k+1}} \right]^T \lambda_{k+1}.
       \end{split}
     \end{equation}

     \paragraph{Solving for $\lambda$:} Setting $\pd{\cal{L}}{\ddot{q}_k} = 0$ yields,
     \begin{equation}
       \begin{split}
         \left[ \pd{R_k}{\ddot{q}_k} + \gamma h \pd{R_k}{\dot{q}_k} + \beta h^2 \pd{R_k}{{q}_k} \right]^T \lambda_k = &- \left\{ \pd{f_k}{\ddot{q}_k} + \gamma h \pd{f_k}{\dot{q}_k} + \beta h^2 \pd{f_k}{{q}_k} \right\}^T \\
         & -  \frac{1}{h}\left\{  \gamma h  \psi_k + \beta h^2   \phi_k \right\}^T\\
         & -  \left\{ (1-\gamma) h \pd{f_{k+1}}{\dot{q}_{k+1}} + \frac{1-2\beta}{2} h^2 \pd{f_{k+1}}{{q}_{k+1}} \right\}^T \\
         & -  \left[ (1-\gamma) h \pd{R_{k+1}}{\dot{q}_{k+1}} + \frac{1-2\beta}{2} h^2 \pd{R_{k+1}}{{q}_{k+1}} \right]^T\lambda_{k+1} \\
         & -  \frac{1}{h} \left\{ (1-\gamma) h \psi_{k+1} + \frac{1-2\beta}{2} h^2 \phi_{k+1} \right\}^T.
       \end{split}
     \end{equation}
     We can equivalently scale the equation with $1/h^2$ and represent as follows,
     \begin{equation}
       \begin{split}
         \left[ \frac{1}{h^2} \pd{R_k}{\ddot{q}_k} + \gamma \frac{1}{h} \pd{R_k}{\dot{q}_k} + \beta \pd{R_k}{{q}_k} \right]^T \lambda_k = &- \left\{ \frac{1}{h^2}  \pd{f_k}{\ddot{q}_k} + \gamma \frac{1}{h} \pd{f_k}{\dot{q}_k} + \beta \pd{f_k}{{q}_k} \right\}^T \\
         & -  \frac{1}{h}\left\{  \gamma \frac{1}{h}  \psi_k + \beta   \phi_k \right\}^T\\
         & -  \left\{ (1-\gamma) \frac{1}{h} \pd{f_{k+1}}{\dot{q}_{k+1}} + \frac{1-2\beta}{2} \pd{f_{k+1}}{{q}_{k+1}} \right\}^T \\
         & -  \left[ (1-\gamma) \frac{1}{h} \pd{R_{k+1}}{\dot{q}_{k+1}} + \frac{1-2\beta}{2} \pd{R_{k+1}}{{q}_{k+1}} \right]^T\lambda_{k+1} \\
         & -  \frac{1}{h} \left\{ (1-\gamma) \frac{1}{h} \psi_{k+1} + \frac{1-2\beta}{2} \phi_{k+1} \right\}^T.
       \end{split}
     \end{equation}
     Grouping the terms together we get,
     \begin{equation}
       \begin{split}
         \left[ \frac{1}{h^2} \pd{R_k}{\ddot{q}_k} + \gamma \frac{1}{h} \pd{R_k}{\dot{q}_k} + \beta \pd{R_k}{{q}_k} \right]^T \lambda_k = &- \left\{ \frac{1}{h^2}  \pd{f_k}{\ddot{q}_k} + \gamma \frac{1}{h} \pd{f_k}{\dot{q}_k} + \beta \pd{f_k}{{q}_k} \right\}^T \\
         & -  \left\{  \gamma \frac{1}{h}  \pd{f_{k+1}}{\dot{q}_{k+1}} +  \gamma \pd{f_{k+1}}{{q}_{k+1}} \right\}^T \\ 
         & -  \left[  \gamma \frac{1}{h}  \pd{R_{k+1}}{\dot{q}_{k+1}} + \gamma \pd{R_{k+1}}{{q}_{k+1}} \right]^T \lambda_{k+1}  \\
         & -  \left\{ \beta \pd{f_{k+1}}{{q}_{k+1}} \right\}^T \\ 
         & -  \left[  \beta\pd{R_{k+1}}{{q}_{k+1}} \right]^T \lambda_{k+1}  \\
         & -  \left\{ (1-\gamma) \frac{1}{h} \pd{f_{k+1}}{\dot{q}_{k+1}} + (\frac{1}{2}-\beta) \pd{f_{k+1}}{{q}_{k+1}} \right\}^T \\
         & -  \left[ (1-\gamma) \frac{1}{h} \pd{R_{k+1}}{\dot{q}_{k+1}} + (\frac{1}{2}-\beta) \pd{R_{k+1}}{{q}_{k+1}} \right]^T\lambda_{k+1} \\
         & -  \frac{1}{h} \left\{ \frac{1}{h} \psi_{k+1} + (\frac{1}{2} +\gamma) \phi_{k+1} \right\}^T.
       \end{split}
     \end{equation}
     
     \begin{equation}
       \begin{split}
         \left[ \frac{1}{h^2} \pd{R_k}{\ddot{q}_k} + \gamma \frac{1}{h} \pd{R_k}{\dot{q}_k} + \beta \pd{R_k}{{q}_k} \right]^T \lambda_k = &- \left\{ \frac{1}{h^2}  \pd{f_k}{\ddot{q}_k} + \gamma \frac{1}{h} \pd{f_k}{\dot{q}_k} + \beta \pd{f_k}{{q}_k} \right\}^T \\
         & -  \left\{  \frac{1}{h} \pd{f_{k+1}}{\dot{q}_{k+1}} +  (\frac{1}{2} +\gamma) \pd{f_{k+1}}{{q}_{k+1}} \right\}^T \\
         & -  \left[  \frac{1}{h} \pd{R_{k+1}}{\dot{q}_{k+1}} +  (\frac{1}{2} +\gamma)  \pd{R_{k+1}}{{q}_{k+1}} \right]^T\lambda_{k+1} \\
         & -  \frac{1}{h} \left\{ \frac{1}{h} \psi_{k+1} + (\frac{1}{2} +\gamma) \phi_{k+1} \right\}^T\\
       \end{split}
     \end{equation}

     The total derivative can be computed as follows:
     $$\pd{\cal{L}}{x} = \pd{F}{x} = \sum_{k=0}^N h \pd{f_k}{x}^T + \sum_{k=0}^N h
     \pd{R_k}{x}^T \lambda_k.$$

     \section{Adams--Bashforth--Moulton}

     The second--order governing differential equations are posed in the following
     descriptor form at the k-th time step:
     $$ R_k(\underline{\ddot{q}_k}, \dot{q}_k, q_k, t_k , x) = 0.$$
     We use an m$^{th}$ order Adams--Bashforth--Moulton (ABM) method to approximate the states:
     $$ S_k =   \dot{q}_{k-1}  + h \sum_{i=0}^{m-1} a_i \ddot{q}_{k-i} - \underline{\dot{q}_k} $$ 
     $$ T_k =   {q}_{k-1}  + h \sum_{i=0}^{m-1} a_i \dot{q}_{k-i} - \underline{{q}_k} .$$
     The acceleration states $\ddot{q}_k$ are the primary unknown at each time step. We introduce $\lambda_k$, $\psi_k$ and $\phi_k$ as adjoint variables
     associated with respective equations. The Lagrangian function is written
     as:
     $${\cal{L}} = \sum_{k=0}^N h f_k + \sum_{k=0}^N h \lambda_k^T
     R_k + \sum_{k=0}^N \psi_k^T S_k + \sum_{k=0}^N \phi_k^T T_k. $$
     The stationary point of the Lagrangian yields the set of linear
     equations for the adjoint system.

     \subsection{First Order ABM}

     \subsubsection{Forward Mode}

     \paragraph{Step $k=1$:}
     The initial conditions are $q_1$, $\dot{q}_1$.
     
     \paragraph{Step $k=2$:}
     The state variables are determined at this step using the
     following relations.
     \begin{equation}\nonumber
       \begin{split}
         \dot{q}_{2} &= \dot{q}_1 + h a_{11} \ddot{q}_{2}  \\
         q_{2}       &= q_1 + h a_{11} \dot{q}_{2}
       \end{split}
     \end{equation}

     \begin{table}[H]
       \centering
       \begin{tabular}{l | l  |l}
         $\lambda_{2}^T$ & $h$ & $R_2(\ddot{q}_2, \dot{q}_1 + h a_{11} \ddot{q}_{2},  q_1 + h a_{11} \dot{q}_{2} )$\\
                        & $h$ & $f_2(\ddot{q}_2, \dot{q}_1 + h a_{11} \ddot{q}_{2},  q_1 + h a_{11} \dot{q}_{2} )$\\
         $\psi_2^T$ & & $\mathbf{S_2}\left(\dot{q}_1 + h a_{11} \ddot{q}_{2}- \dot{q}_{2} \right)$ \\
         $\phi_2^T$ & & $\mathbf{T_2}\left(q_1 + h a_{11} \dot{q}_{2} - q_{2}\right) $ \\
       \end{tabular}
     \end{table}

     \paragraph{Step $k=3$:}
     The state variables are determined at this step using the
     following relations.
     \begin{equation}\nonumber
       \begin{split}
         \dot{q}_{3} &= \dot{q}_2 + h a_{11} \ddot{q}_{3}  \\
         q_{3}       &= q_2 + h a_{11} \dot{q}_{3}
       \end{split}
     \end{equation}

     \begin{table}[H]
       \centering
       \begin{tabular}{l | l  |l}
         $\lambda_{3}^T$ & $h$ & $R_3(\ddot{q}_3, \dot{q}_2 + h a_{11} \ddot{q}_{3},  q_2 + h a_{11} \dot{q}_{3} )$\\
                        & $h$ & $f_3(\ddot{q}_3, \dot{q}_2 + h a_{11} \ddot{q}_{3},  q_2 + h a_{11} \dot{q}_{3} )$\\
         $\psi_3^T$ & & $\mathbf{S_3}\left(\dot{q}_2 + h a_{11} \ddot{q}_{3}- \dot{q}_{3} \right)$ \\
         $\phi_3^T$ & & $\mathbf{T_3}\left(q_2 + h a_{11} \dot{q}_{3} - q_{3}\right) $ \\
       \end{tabular}
     \end{table}

     \paragraph{Step $k=4$:}
     The state variables are determined at this step using the
     following relations.

     \begin{equation}\nonumber
       \begin{split}
         \dot{q}_{4} &= \dot{q}_3 + h a_{11} \ddot{q}_{4}  \\
         q_{4}       &= q_3 + h a_{11} \dot{q}_{4}
       \end{split}
     \end{equation}

     \begin{table}[H]
       \centering
       \begin{tabular}{l | l  |l}
         $\lambda_{4}^T$ & $h$ & $R_4(\ddot{q}_4, \dot{q}_3 + h a_{11} \ddot{q}_{4},
         q_3 + h a_{11} \dot{q}_{4} )$ \\
         & $h$ & $f_4(\ddot{q}_4, \dot{q}_3 + h a_{11} \ddot{q}_{4},  q_3 + h a_{11} \dot{q}_{4} )$\\
         $\psi_4^T$ & & $\mathbf{S_4}\left(\dot{q}_3 + h a_{11} \ddot{q}_{4}- \dot{q}_{4} \right)$ \\
         $\phi_4^T$ & & $\mathbf{T_4}\left(q_3 + h a_{11} \dot{q}_{4} - q_{4}\right) $ \\
       \end{tabular}
     \end{table}

     \subsubsection{Reverse Mode}

     We solve for the adjoint variables starting from the last time
     step.

     \paragraph{Step $k=4$:}

     \begin{itemize}
       
     \item Setting $\pd{L}{q_4}=0$, we get:
       $$  \pd{T_4}{q_4}^T \phi_4 = 0$$
       \begin{center}
       \boxed{
         $$
         \phi_4 = 0
         $$
       }
       \end{center}

     \item Setting $\pd{L}{\dot{q}_4}=0$, we get:
       $$  \pd{S_4}{\dot{q}_4}^T \psi_4  + \pd{T_4}{\dot{q}_4}^T \phi_4 = 0$$
       \begin{center}
         \boxed{
           $$
           \psi_4 = 0
           $$
         }
       \end{center}
       
     \item Setting $\pd{L}{\ddot{q}_4}=0$, we get:
       $$ h \pd{R_4}{\ddot{q}_4}^T \lambda_4 + h \pd{f_4}{\ddot{q_4}}^T + \pd{S_4}{\ddot{q}_4}^T \psi_4 = 0$$ %  + \pd{T_4}{\ddot{q}_4}^T \phi_4 

       \begin{center}
         \boxed{
           h \left[ \pd{R_4}{\ddot{q_4}} + ha_{11} \pd{R_4}{\dot{q_4}} + h^2 a_{11}^2 \pd{R_4}{q_4} \right]^T\lambda_4 +
           h \left\{ \pd{f_4}{\ddot{q_4}} + ha_{11} \pd{f_4}{\dot{q_4}} + h^2 a_{11}^2 \pd{f_4}{q_4} \right\}^T +
           ha_{11} \psi_4  = 0 % + h^2 a_{11}^2\phi_4 = 0
         }
       \end{center}
       
     \end{itemize}
    
     \paragraph{Step $k=3$:}

     \begin{itemize}
       
     \item Setting $\pd{L}{q_3}=0$, we get:
       
       $$  \pd{T_3}{q_3}^T \phi_3 + \pd{T_4}{q_3}^T \phi_4 + h \left[ \pd{R_4}{q_3}\right]^T \lambda_4 +  h \left\{ \pd{f_4}{q_3}\right\}^T = 0$$
       
       \begin{center}
         \boxed{
           $$
           \phi_3 = \phi_4 + h \left[ \pd{R_4}{q_4} \right]^T \lambda_4 + h \left\{ \pd{f_4}{q_4} \right\}^T
           $$
         }
       \end{center}

     \item Setting $\pd{L}{\dot{q}_3}=0$, we get:
       $$  \pd{S_3}{\dot{q}_3}^T \psi_3  + \pd{T_3}{\dot{q}_3}^T \phi_3 + \pd{S_4}{\dot{q}_3}^T \psi_4+ \pd{T_4}{\dot{q}_3}^T \phi_4
       + h \left[ \pd{R_4}{\dot{q}_3} \right]^T \lambda_4 + h \left\{ \pd{f_4}{\dot{q}_3} \right\}^T
       = 0 $$
       \begin{center}
         \boxed{
           $$
           \psi_3 = ha_{11} \phi_3 + \psi_4
           + h \left[ \pd{R_4}{\dot{q}_4} + ha_{11} \pd{R_4}{{q}_4} \right]^T \lambda_4
           + h \left\{ \pd{f_4}{\dot{q}_4} + ha_{11} \pd{f_4}{{q}_4} \right\}^T
           $$
         }
       \end{center}
        
     \item  Setting $\pd{L}{\ddot{q}_3}=0$, we get:
       $$ h \pd{R_3}{\ddot{q}_3}^T \lambda_3 + h \pd{f_3}{\ddot{q_3}}^T + \pd{S_3}{\ddot{q}_3}^T \psi_3
 %      + h \pd{R_4}{\ddot{q}_3}^T \lambda_4 + h \pd{f_4}{\ddot{q_3}}^T + \pd{S_4}{\ddot{q}_3}^T \psi_4  + \pd{T_4}{\ddot{q}_3}^T \phi_4
       = 0$$

            %  $$ h \pd{R_3}{\ddot{q}_3}^T \lambda_3 + h \pd{f_3}{\ddot{q_3}}^T + \pd{S_3}{\ddot{q}_3}^T \psi_3  + \pd{T_3}{\ddot{q}_3}^T \phi_3
%       + h \pd{R_4}{\ddot{q}_3}^T \lambda_4 + h \pd{f_4}{\ddot{q_3}}^T + \pd{S_4}{\ddot{q}_3}^T \psi_4  + \pd{T_4}{\ddot{q}_3}^T \phi_4
%       = 0$$
       
       \begin{center}
         \boxed{
           h \left[ \pd{R_3}{\ddot{q_3}} + ha_{11} \pd{R_3}{\dot{q_3}} + h^2 a_{11}^2 \pd{R_3}{q_3} \right]^T\lambda_3 +
           h \left\{ \pd{f_3}{\ddot{q_3}} + ha_{11} \pd{f_3}{\dot{q_3}} + h^2 a_{11}^2 \pd{f_3}{q_3} \right\}^T +
           ha_{11} \psi_3  = 0
         }
       \end{center}

     \end{itemize}

     \paragraph{General Relations:}
     We can identify the recursive relations based on the above
     equations.


     \begin{center}
         \boxed{
           $$
           \phi_k = \phi_{k+1} + h \left[ \pd{R_{k+1}}{q_{k+1}} \right]^T \lambda_{k+1}
           + h \left\{ \pd{f_{k+1}}{q_{k+1}} \right\}^T
           $$
         }
     \end{center}
     
     \begin{center}
       \boxed{
         $$
         \psi_k = ha_{11} \phi_k + \psi_{k+1} +
         + h \left[ \pd{R_{k+1}}{\dot{q}_{k+1}} + ha_{11} \pd{R_{k+1}}{{q}_{k+1}} \right]^T \lambda_{k+1}
         + h \left\{ \pd{f_{k+1}}{\dot{q}_{k+1}} + ha_{11} \pd{f_{k+1}}{{q}_{k+1}} \right\}^T
         $$
       }
     \end{center}
     
     \begin{center}
       \boxed{
         h \left[ \pd{R_k}{\ddot{q_k}} + ha_{11} \pd{R_k}{\dot{q_k}} + h^2 a_{11}^2 \pd{R_k}{q_k} \right]^T\lambda_k +
         h \left\{ \pd{f_k}{\ddot{q_k}} + ha_{11} \pd{f_k}{\dot{q_k}} + h^2 a_{11}^2 \pd{f_k}{q_k} \right\}^T +
         ha_{11} \psi_k  = 0
       }
     \end{center}
     
     \clearpage
     % Differentiate wrt to q
     \paragraph{Solve for $\phi$:}
     
     Setting $\pd{\cal{L}}{{q}_k} = 0$ yields:
     $$ \phi_{k}^T \pd{T_k}{q_k} + \phi_{k+1}^T \pd{T_{k+1}}{q_k} + h \lambda_{k+1}^T \pd{R_{k+1}}{q_{k}}
     + h \pd{f_{k+1}}{q_{k}}
     = 0 $$ which simplifies to

     \begin{center}
       \boxed{
         $$
         \phi_k = \phi_{k+1} + h \left[  \pd{R_{k+1}}{q_{k+1}} \right]^T \lambda_{k+1} + h \left\{ \pd{f_{k+1}}{q_{k+1}} \right\}^T
         $$
       }
     \end{center}

     % Differentiate wrt to qdot

     \paragraph{Solve for $\psi$:}
     Setting $\pd{\cal{L}}{\dot{q}_k} = 0$ yields:
     $$
     \psi_k^T \pd{S_k}{\dot{q}_k} + \psi_{k+1}^T \pd{S_{k+1}}{\dot{q}_k} +
     \sum_{i=0}^{m-1} \phi_{k+i}^T \pd{T_{k+i}}{\dot{q}_k}  + h \sum_{i=1}^{m-1} \lambda_{k+i}^T \pd{R_{k+i}}{\dot{q}_k} 
     + h \sum_{i=1}^{m-1} \pd{f_{k+i}}{\dot{q}_k} = 0
     $$ which simplifies to
     \begin{equation}
       \begin{split}
         \psi_k = \psi_{k+1} + h \sum_{i=0}^{m-1} a_{i} \phi_{k+i} & + h \sum_{i=1}^{m-1}
         \left[ \pd{R_{k+i}}{\dot{q}_{k+i}} + \sum_{j=0}^{i} ha_j \pd{R_{k+i}}{{q}_{k+i}}  \right]^T \lambda_{k+1}
          + h \sum_{i=1}^{m-1}
         \left\{ \pd{f_{k+i}}{\dot{q}_{k+i}} + \sum_{j=0}^{i} ha_j \pd{f_{k+i}}{{q}_{k+i}}  \right\}^T
       \end{split}
     \end{equation}

     % Differentiate wrt to qddot
     \paragraph{Solve for $\lambda$:} Setting $\pd{\cal{L}}{\ddot{q}_k} = 0$ yields:

     $$ h \lambda_k^T \pd{R_k}{\ddot{q}_k} + h \pd{f_k}{\ddot{q}_k} +
     \sum_{i=1}^{m-1} h \lambda_{k+i}^T \pd{R_{k+i}}{\ddot{q}_k} + \sum_{i=1}^{m-1} h
     \pd{f_{k+1}}{\ddot{q}_k} + \sum_{i=0}^{m-1} \psi_{k+i}^T
     \pd{S_{k+i}}{\ddot{q}_k} +
     \pd{T_{k+i}}{\ddot{q}_k}
     =0
     $$
     which simplifies to
     \begin{equation}
       \begin{split}
         h \left[ \pd{R_k}{\ddot{q}_k} + h a_0 \pd{R_k}{\dot{q}_k} +  h^2 a_0^2  \pd{R_k}{{q}_k} \right]^T \lambda_k = & -  h \left\{ \pd{R_k}{\ddot{q}_k} + h a_0 \pd{R_k}{\dot{q}_k} +  h^2 a_0^2  \pd{R_k}{{q}_k} \right\}^T\\
         & - h \sum_{i=1}^{m-1} h \left[ \pd{R_{k+i}}{\dot{q}_{k+i}}\pd{\dot{q}_{k+i}}{\ddot{q}_k} + \pd{R_{k+i}}{q_{k+i}}\pd{q_{k+i}}{\ddot{q}_k} \right]^T \lambda_{k+i}\\
         & - h \sum_{i=1}^{m-1} h \left\{ \pd{f_{k+i}}{\dot{q}_{k+i}}\pd{\dot{q}_{k+i}}{\ddot{q}_k} + \pd{f_{k+i}}{q_{k+i}}\pd{q_{k+i}}{\ddot{q}_k} \right\}^T\\
         & - h \sum_{i=0}^{m-1} ha_i \psi_{k+i}\\
         & - h \sum_{i=0}^{m-1} ha_iha_i \psi_{k+i}
       \end{split}
     \end{equation}

     \subsection{Second Order ABM}

     \subsubsection{Forward Mode}
     
     \paragraph{Step $k=1$:}
     The initial conditions are $q_1$, $\dot{q}_1$.
     
     \paragraph{Step $k=2$:}
     The state variables are determined at this step using the
     following relations.
     \begin{equation}\nonumber
       \begin{split}
         \dot{q}_{2} &= \dot{q}_1 + h a_{11} \ddot{q}_{2}  \\
         q_{2}       &= q_1 + h a_{21} \dot{q}_{2} + ha_{22} \dot{q}_{1}
       \end{split}
     \end{equation}

     \begin{table}[H]
       \centering
       \begin{tabular}{l | l  |l}
         $\lambda_{2}^T$ & $h$ & $R_2(\ddot{q}_2, \dot{q}_1 + h a_{11} \ddot{q}_{2},  q_1 + h a_{21} \dot{q}_{2} + h a_{22} \dot{q}_1)$\\
         & $h$ & $f_2(\ddot{q}_2, \dot{q}_1 + h a_{11} \ddot{q}_{2},  q_1 + h a_{21} \dot{q}_{2} + h a_{22} \dot{q}_1 )$\\
         $\psi_2^T$ & & $S_2\left(\dot{q}_1 + h a_{11} \ddot{q}_{2} - \dot{q}_{2} \right)$ \\
         $\phi_2^T$ & & $T_2\left(q_1 + h a_{21} \dot{q}_{2} + h a_{22} \dot{q}_1 - q_{2}\right) $ \\
       \end{tabular}
     \end{table}

     \paragraph{Step $k=3$:}
     The state variables are determined at this step using the
     following relations.
     \begin{equation}\nonumber
       \begin{split}
         \dot{q}_{3} &= \dot{q}_2 + h a_{21} \ddot{q}_{3} + h a_{22} \ddot{q}_{2} \\
         q_{3}       &=      q_2  + h a_{21} \dot{q}_{3}  + h a_{22} \dot{q}_{2}
       \end{split}
     \end{equation}

     \begin{table}[H]
       \centering
       \begin{tabular}{l | l  |l}
         $\lambda_{3}^T$  & $h$ & $R_3(\ddot{q}_3, \dot{q}_2 + h a_{21} \ddot{q}_{3} + h a_{22} \ddot{q}_{2}, q_2 + h a_{21} \dot{q}_{3} + h a_{22} \dot{q}_2)$ \\
                         & $h$ & $f_3(\ddot{q}_3, \dot{q}_2 + h a_{21} \ddot{q}_{3} + h a_{22} \ddot{q}_{2}, q_2 + h a_{21} \dot{q}_{3} + h a_{22} \dot{q}_2)$ \\
         $\psi_3^T$      &     & $S_3\left(\dot{q}_2 + h a_{21} \ddot{q}_{3} + h a_{22} \ddot{q}_{2} - \dot{q}_{3} \right)$ \\
         $\phi_3^T$      &     & $T_3\left(q_2 + h a_{21} \dot{q}_{3} + h a_{22} \dot{q}_2 - q_{3} \right) $ \\
       \end{tabular}
     \end{table}



    \paragraph{Step $k=4$:}
     The state variables are determined at this step using the
     following relations.
     \begin{equation}\nonumber
       \begin{split}
         \dot{q}_{4} &= \dot{q}_3 + h a_{21} \ddot{q}_{4} + h a_{22} \ddot{q}_{3} \\
         q_{4}       &=      q_3  + h a_{21} \dot{q}_{4}  + h a_{22} \dot{q}_{3}
       \end{split}
     \end{equation}

     \begin{table}[H]
       \centering
       \begin{tabular}{l | l  |l}
         $\lambda_{4}^T$  & $h$ & $R_4(\ddot{q}_4, \dot{q}_3 + h a_{21} \ddot{q}_{4} + h a_{22} \ddot{q}_{3} ,q_3 + h a_{21} \dot{q}_{4} + h a_{22} \dot{q}_3)$ \\
                         & $h$ & $f_4(\ddot{q}_4, \dot{q}_3 + h a_{21} \ddot{q}_{4} + h a_{22} \ddot{q}_{3} ,q_3 + h a_{21} \dot{q}_{4} + h a_{22} \dot{q}_3)$ \\
         $\psi_4^T$      &     & $S_4\left(\dot{q}_3 + h a_{21} \ddot{q}_{4} + h a_{22} \ddot{q}_{3} - \dot{q}_{4} \right)$ \\
         $\phi_4^T$      &     & $T_4\left(q_3 + h a_{21} \dot{q}_{4} + h a_{22} \dot{q}_3 - q_{4} \right) $ \\
       \end{tabular}
     \end{table}

     \subsubsection{Reverse Mode}

     We solve for the adjoint variables starting from the last time
     step.

     \paragraph{Step $k=4$:}

     \begin{itemize}
       
     \item Setting $\pd{L}{q_4}=0$, we get:
       $$  \pd{T_4}{q_4}^T \phi_4 = 0$$

       \begin{center}
         \boxed{
           $$
           \phi_4 = 0
           $$
         }
       \end{center}

     \item Setting $\pd{L}{\dot{q}_4}=0$, we get:
       $$  \pd{S_4}{\dot{q}_4}^T \psi_4  + \pd{T_4}{\dot{q}_4}^T \phi_4 = 0$$
       \begin{center}
         \boxed{
           $$
           \psi_4 = 0
           $$
         }
       \end{center}
       
     \item Setting $\pd{L}{\ddot{q}_4}=0$, we get:
       $$ h \pd{R_4}{\ddot{q}_4}^T \lambda_4 + h \pd{f_4}{\ddot{q_4}}^T + \pd{S_4}{\ddot{q}_4}^T \psi_4 = 0$$ %  + \pd{T_4}{\ddot{q}_4}^T \phi_4 

       \begin{center}
         \boxed{
           h \left[ \pd{R_4}{\ddot{q_4}} + ha_{22} \pd{R_4}{\dot{q_4}} + h^2 a_{22}^2 \pd{R_4}{q_4} \right]^T\lambda_4 +
           h \left\{ \pd{f_4}{\ddot{q_4}} + ha_{22} \pd{f_4}{\dot{q_4}} + h^2 a_{22}^2 \pd{f_4}{q_4} \right\}^T +
           ha_{22} \psi_4  = 0 % + h^2 a_{22}^2\phi_4 = 0
         }
       \end{center}
       
     \end{itemize}
     
     % k = 3 reverse second order ABM
     \paragraph{Step $k=3$:}

     \begin{itemize}
       
     \item Setting $\pd{L}{q_3}=0$, we get:
       
       $$  \pd{T_3}{q_3}^T \phi_3 + \pd{T_4}{q_3}^T \phi_4 + h \left[ \pd{R_4}{q_3}\right]^T \lambda_4 +  h \left\{ \pd{f_4}{q_3}\right\}^T = 0$$
       
       \begin{center}
         \boxed{
           $$
           \phi_3 = \phi_4 + h \left[ \pd{R_4}{q_4} \right]^T \lambda_4 + h \left\{ \pd{f_4}{q_4} \right\}^T
           $$
         }
       \end{center}

     \item Setting $\pd{L}{\dot{q}_3}=0$, we get:
       $$  \pd{S_3}{\dot{q}_3}^T \psi_3  + \pd{T_3}{\dot{q}_3}^T \phi_3 
       + \pd{S_4}{\dot{q}_3}^T \psi_4+ \pd{T_4}{\dot{q}_3}^T \phi_4
       + h \left[ \pd{R_4}{\dot{q}_3} \right]^T \lambda_4 + h \left\{ \pd{f_4}{\dot{q}_3} \right\}^T
       = 0 $$
       \begin{center}
         \boxed{
           $$
           \psi_3 = ha_{21} \phi_3 + \psi_4 + ha_{22}\phi_4
           + h \left[ \pd{R_4}{\dot{q}_4} + ha_{22} \pd{R_4}{{q}_4} \right]^T \lambda_4
           + h \left\{ \pd{f_4}{\dot{q}_4} + ha_{22} \pd{f_4}{{q}_4} \right\}^T
           $$
         }
       \end{center}
       
     \item  Setting $\pd{L}{\ddot{q}_3}=0$, we get:
       $$ h \pd{R_3}{\ddot{q}_3}^T \lambda_3 + h \pd{f_3}{\ddot{q_3}}^T + \pd{S_3}{\ddot{q}_3}^T \psi_3  + \pd{T_3}{\ddot{q}_3}^T \phi_3
      + \pd{S_4}{\ddot{q}_3}^T \psi_4  + \pd{T_4}{\ddot{q}_3}^T \phi_4  + h \pd{R_4}{\ddot{q}_3}^T \lambda_4 + h \pd{f_4}{\ddot{q_3}}^T 
       = 0$$
       
       \begin{equation}
         \begin{split}
           h \left[ \pd{R_3}{\ddot{q_3}}  + ha_{22} \pd{R_3}{\dot{q_3}} + h^2 a_{22}^2 \pd{R_3}{q_3} \right]^T\lambda_3 = & - h \left\{ \pd{f_3}{\ddot{q_3}} + ha_{22} \pd{f_3}{\dot{q_3}}+ h^2 a_{22}^2 \pd{f_3}{q_3} \right\}^T  \\ 
           & - h a_{21} \psi_3 \\
           & - h \left[ ha_{22} \pd{R_4}{\dot{q_4}} + h^2 a_{22}^2 \pd{R_4}{q_4} \right]^T\lambda_4 \\
           & - h \left\{ ha_{22} \pd{f_4}{\dot{q_4}} + h^2 a_{22}^2 \pd{f_4}{q_4} \right\}^T \\
           & - h a_{22} \psi_{4} - (h a_{21} h a_{22} + h a_{22} h a_{21}) \phi_{4}
         \end{split}
       \end{equation}

     \end{itemize}

     \section{Diagonally--Implicit--Runge--Kutta}

     The residual of the governing equations and the objective
     function of interest are written as follows.
     $$R_{ki} = R_{ki}(\ddot{q_{ki}},\dot{q_{ki}},q_{ki},t_{ki}, x)$$
     and 
     $$F_{ki} =  h b_i f_{ki}(\ddot{q_{ki}},\dot{q_{ki}},q_{ki},t_{ki}, x).$$
     The stage states are,
     $$ S_k = \dot{q}_{k-1} + h \sum_{i=1}^s b_k \ddot{q}_{ki} - \dot{q}_{k} $$ and
     $$ T_k = q_{k-1} + h \sum_{i=1}^s b_k \dot{q}_{ki} - q_{k}.$$

     $$\mathbf{q_1} \xrightarrow[\dot{q}_{21},\dot{q}_{22}\ldots\dot{q}_{2s}]{q_{21},q_{22}\ldots q_{2s}} \mathbf{q_2} \xrightarrow[\dot{q}_{31},\dot{q}_{32}\ldots\dot{q}_{3s}]{q_{31},q_{32}\ldots q_{3s}} \mathbf{q_3} \xrightarrow[\dot{q}_{N,1},\dot{q}_{N,2}\ldots\dot{q}_{N,s}]{q_{N,1},q_{N,2}\ldots q_{N,s}} \mathbf{q_N}$$

     $$\mathbf{\dot{q}_1} \xrightarrow[\ddot{q}_{21},\ddot{q}_{22}\ldots\ddot{q}_{2s}]{\dot{q}_{21},\dot{q}_{22}\ldots \dot{q}_{2s}} \mathbf{\dot{q}_2} \xrightarrow[\ddot{q}_{31},\ddot{q}_{32}\ldots\ddot{q}_{3s}]{\dot{q}_{31},\dot{q}_{32}\ldots \dot{q}_{3s}} \mathbf{\dot{q}_3} \xrightarrow[\ddot{q}_{N,1},\ddot{q}_{N,2}\ldots\ddot{q}_{N,s}]{\dot{q}_{N,1},\dot{q}_{N,2}\ldots \dot{q}_{N,s}} \mathbf{\dot{q}_N}$$

     We form an Lagrangian function:
     $$ {\cal{L}} = \sum_{k=2}^{N} \sum_{i=1}^s h b_i f_{ki} +
     \sum_{k=2}^{N} \sum_{i=1}^s\lambda_{ki}^T h b_i R_{ki} +
     \sum_{k=1}^N \psi_k^T S_k + \sum_{k=1}^N \phi_k^T T_k. $$
     We find the stationary points of the Lagrangian in an attempt to
     generate the system of equations to solve for the adjoint variables.

     \subsection{One--Staged DIRK}
     The one-staged DIRK is a second-order scheme. We write out a few
     time steps of integration and study the recursive relations.

     \subsection{Two--Staged DIRK}
     The two-staged DIRK is a third-order scheme. We write out a few
     time steps of integration and study the recursive relations.


     \paragraph{Time step $k=2$:}
     The state variables have the following relations at this time-step.
     \begin{equation}\nonumber
       \begin{split}
         q_{21} &= q_1 + h a_{11} \dot{q}_{21} \\
         q_{22} &= q_1 + h a_{21} \dot{q}_{21} + h a_{22} \dot{q}_{22} \\
         \dot{q}_{21} &= \dot{q}_1 + h a_{11} \ddot{q}_{21} \\
         \dot{q}_{22} &= \dot{q}_1 + h a_{21} \ddot{q}_{21} + h a_{22} \ddot{q}_{22} \\
       \end{split}
     \end{equation}

     \begin{table}[H]
       \centering
       \begin{tabular}{l | l  |l}
         $\lambda_{21}^T$ & $hb_1$ & $\mathbf{R_{21}}\left(\underline{\mathbf{\ddot{q}_{21}}},\mathbf{\dot{q}_{21}}(\dot{q_1},\ddot{q_{21}}),\mathbf{{q}_{21}}({q_1},\dot{q_{21}}(\dot{q_1},\ddot{q_{21}}))\right) $ \\
         $\lambda_{22}^T$ & $hb_2$ & $\mathbf{R_{22}}\left(\underline{\mathbf{\ddot{q}_{22}}},\mathbf{\dot{q}_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}),\mathbf{{q}_{22}}({q_1},\dot{q_{21}}(\dot{q_1},\ddot{q_{21}}),\dot{q_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}))\right) $ \\
         & $h b_1$ & $\mathbf{f_{21}}\left(\underline{\mathbf{\ddot{q}_{21}}},\mathbf{\dot{q}_{21}}(\dot{q_1},\ddot{q_{21}}),\mathbf{{q}_{21}}({q_1},\dot{q_{21}}(q_1,\ddot{q_{21}}))\right) $ \\
         & $h b_2$ & $\mathbf{f_{22}}\left(\underline{\mathbf{\ddot{q}_{22}}},\mathbf{\dot{q}_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}),\mathbf{{q}_{22}}({q_1},\dot{q_{21}}(\dot{q_1},\ddot{q_{21}}),\dot{q_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}))\right) $\\
         $\psi_2^T$ & & $\mathbf{S_2}\left(\dot{q}_1 + h b_1 \ddot{q}_{21} +  h b_2 \ddot{q}_{22} - \underline{\mathbf{\dot{q}_2}} \right)$ \\
         $\phi_2^T$ & & $\mathbf{T_2}\left(q_1 + h b_1 \dot{q}_{21}(\dot{q_1},\ddot{q_{21}}) +  h b_2 \dot{q}_{22} (\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}) - \underline{\mathbf{q_2}} \right) $ \\
       \end{tabular}
     \end{table}

     \paragraph{Time Step $k=3$:}
     The state variables have the following relations at this time-step.
     \begin{equation}\nonumber
       \begin{split}
         q_{31} &= q_2 + h a_{11} \dot{q}_{31} \\
         q_{32} &= q_2 + h a_{21} \dot{q}_{31} + h a_{22} \dot{q}_{32} \\
         \dot{q}_{31} &= \dot{q}_2 + h a_{11} \ddot{q}_{31} \\
         \dot{q}_{32} &= \dot{q}_2 + h a_{21} \ddot{q}_{31} + h a_{22} \ddot{q}_{32} \\
       \end{split}
     \end{equation}

     The equations from this step are:
     \begin{table}[H]
       \centering
       \begin{tabular}{l | l | l}
         $\lambda_{31}^T$ & $h b_1$ & $\mathbf{R_{31}}\left(\underline{\mathbf{\ddot{q}_{31}}},
         \mathbf{\dot{q}_{31}}(\dot{q_2},\ddot{q_{31}}),
         \mathbf{{q}_{31}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}))\right) $ \\
         $\lambda_{32}^T$ & $h b_2$ &  $\mathbf{R_{32}}\left(\underline{\mathbf{\ddot{q}_{32}}},\mathbf{\dot{q}_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}), \mathbf{{q}_{32}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}),\dot{q_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}))\right) $ \\
         & $h b_1$ & $\mathbf{f_{31}}\left(\underline{\mathbf{\ddot{q}_{31}}}, \mathbf{\dot{q}_{31}}(\dot{q_2},\ddot{q_{31}}), \mathbf{{q}_{31}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}))\right) $ \\
         & $h b_2$ & $\mathbf{f_{32}}\left(\underline{\mathbf{\ddot{q}_{32}}},
         \mathbf{\dot{q}_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}),
         \mathbf{{q}_{32}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}),\dot{q_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}))\right) $ \\
         $\psi_3^T$ && $\mathbf{S_3}(\dot{q}_2 + h b_1 \ddot{q}_{31} +  h b_2 \ddot{q}_{32} - \underline{\mathbf{\dot{q}_3}} )$ \\
         $\phi_3^T$ && $\mathbf{T_3}(q_2 + h b_1 \dot{q}_{31}(\dot{q}_2,\ddot{q_{31}}) +  h b_2 \dot{q}_{32}(\dot{q}_2,\ddot{q_{31}},\ddot{q_{32}}) - \underline{\mathbf{q_3}} ) $\\
       \end{tabular}
     \end{table}

     We operate on these equations and generate the adjoint system of equations.

     \begin{table}[H]
       \centering
       \begin{tabular}{c|l}
         $\pd{{\mathcal L}}{{q}_{3}}  = 0$      & $\pd{T_3}{q_3}^T \phi_3 = 0$ \\
         &\\
         $\pd{{\mathcal L}}{\dot{q}_{3}}  = 0$  & $ \pd{{S_3}}{\dot{q}_{3}}^T \psi_3 = 0$  \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{32}} = 0$ & $hb_2\pd{R_{32}}{\ddot{q}_{32}}^T\lambda_{32}+ \pd{T_3}{\ddot{q}_{32}}^T \phi_3 + \pd{S_3}{\ddot{q}_{32}}^T \psi_3 + hb_2\pd{f_{32}}{\ddot{q}_{32}}^T = 0$ \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{31}} = 0$ &   $ h b_1 \pd{R_{31}}{\ddot{q}_{31}}^T \lambda_{31} +  h b_2 \pd{R_{32}}{\ddot{q}_{31}}^T \lambda_{32} +  h b_1 \pd{f_{31}}{\ddot{q}_{31}}^T +  h b_2 \pd{f_{32}}{\ddot{q}_{31}}^T  + \pd{S_3}{\ddot{q}_{31}}^T \psi_3 + \pd{T_3}{\ddot{q}_{31}}^T \phi_3 = 0  $ \\
       \end{tabular}
     \end{table}

     These equations simplify to the following relations:

     \begin{equation}
       \phi_3 = 0
     \end{equation}
     
     \begin{equation}
       \psi_3 = 0
     \end{equation}

     % equation for lamda 32
     \begin{equation}
       \begin{split}
         hb_2\left[\pd{R_{32}}{\ddot{q}_{32}} + ha_{22}\pd{R_{32}}{\dot{q}_{32}} + h^2a_{22}^2 \pd{R_{32}}{{q}_{32}} \right]^T \lambda_{32} = & - hb_2 \left[\pd{f_{32}}{\ddot{q}_{32}} + ha_{22}\pd{f_{32}}{\dot{q}_{32}} + h^2a_{22}^2 \pd{f_{32}}{{q}_{32}} \right]^T \\ 
         & - hb_2  \psi_3 \\ 
         & - hb_2ha_{22}   \phi_3
       \end{split}
     \end{equation}

     % equation for lamda 31
     \begin{equation}
       \begin{split}
         hb_1\left[\pd{R_{31}}{\ddot{q}_{31}} + ha_{11}\pd{R_{31}}{\dot{q}_{31}} + h^2a_{11}^2 \pd{R_{31}}{{q}_{31}} \right]^T \lambda_{31} = & - hb_1 \left[\pd{f_{31}}{\ddot{q}_{31}} + ha_{11}\pd{f_{31}}{\dot{q}_{31}} + h^2a_{11}^2 \pd{f_{31}}{{q}_{31}} \right]^T \\ 
         & - hb_2 \left[ha_{21}\pd{f_{32}}{\dot{q}_{32}} + (ha_{21}ha_{11} + ha_{22}ha_{21}) \pd{f_{32}}{{q}_{32}} \right]^T \\
         & - hb_2 \left[ha_{21}\pd{R_{32}}{\dot{q}_{32}} + (ha_{21}ha_{11} + ha_{22}ha_{21}) \pd{R_{32}}{{q}_{32}} \right]^T\lambda_{32} \\
         & - hb_1 \psi_3 \\ 
         & - (hb_1ha_{11} + hb_2ha_{21})  \phi_3
       \end{split}
     \end{equation}

     \begin{table}[h]
       \centering
       \begin{tabular}{c|l}
         $\pd{{\mathcal L}}{{q}_{2}}  = 0$      & $\pd{T_2}{q_2}^T \phi_2 + hb_1\pd{R_{31}}{q_2}^T\lambda_{31} + hb_2\pd{R_{32}}{q_2}^T \lambda_{32} + hb_1\pd{f_{31}}{q_2}^T + hb_2\pd{f_{32}}{q_2}^T + \pd{T_3}{q_2}^T \phi_3  = 0$ \\
         &\\
         $\pd{{\mathcal L}}{\dot{q}_{2}}  = 0$  & $ \pd{{S_2}}{\dot{q}_{2}}^T \psi_2 + h b_1 \pd{R_{31}}{\dot{q}_2}^T \lambda_{31} + hb_2 \pd{R_{32}}{\dot{q}_2}^T \lambda_{32} + h b_1 \pd{f_{31}}{\dot{q}_2}^T + hb_2 \pd{f_{32}}{\dot{q}_2}^T + \pd{T_3}{\dot{q}_2}^T\phi_3 + \pd{S_3}{\dot{q}_2}^T \psi_3 = 0$  \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{22}} = 0$ & $hb_2\pd{R_{22}}{\ddot{q}_{22}}^T\lambda_{22}+ \pd{T_2}{\ddot{q}_{22}}^T \phi_2 + \pd{S_2}{\ddot{q}_{22}}^T \psi_2 + hb_2\pd{f_{22}}{\ddot{q}_{22}}^T = 0$ \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{21}} = 0$ & $hb_1\pd{R_{21}}{\ddot{q}_{21}}^T \lambda_{21} +  h b_2 \pd{R_{22}}{\ddot{q}_{21}}^T \lambda_{22} +  h b_1 \pd{f_{21}}{\ddot{q}_{21}}^T +  h b_2 \pd{f_{22}}{\ddot{q}_{21}}^T  + \pd{S_2}{\ddot{q}_{21}}^T \psi_2 + \pd{T_2}{\ddot{q}_{21}}^T \phi_2 = 0$ \\
       \end{tabular}
     \end{table}

     % equation for phi2
     \begin{equation}
       \begin{split}
          \psi_2 = &  \psi_3 + (hb_1 + hb_2)  \phi_3  + hb_1 \left[ \pd{R_{31}}{\dot{q}_{31}} + ha_{11} \pd{R_{31}}{q_{31}}  \right]^T \lambda_{31} + hb_1 \left[ \pd{f_{31}}{\dot{q}_{31}} + ha_{11} \pd{f_{31}}{{q}_{31}} \right]^T \\
         & + hb_2 \left[ \pd{R_{32}}{\dot{q_{32}}} + (ha_{21} + ha_{22}) \pd{R_{32}}{q_{32}} \right]^T \lambda_{32} + hb_2 \left[ \pd{f_{32}}{\dot{q_{32}}} + (ha_{21} + ha_{22}) \pd{f_{32}}{q_{32}} \right]^T               
       \end{split}
     \end{equation}

     % equation for psi2
     \begin{equation}
       \begin{split}
          \phi_2 =  \phi_3 + hb_1 \pd{R_{31}}{q_{31}}^T \lambda_{31} + hb_1 \pd{f_{31}}{q_{31}}^T  + hb_2 \pd{R_{32}}{q_{32}}^T \lambda_{32} + hb_2 \pd{f_{32}}{q_{32}}^T
       \end{split}
     \end{equation}


     % equation for lamda 22
     \begin{equation}
       \begin{split}
         hb_2\left[\pd{R_{22}}{\ddot{q}_{22}} + ha_{22}\pd{R_{22}}{\dot{q}_{22}} + h^2a_{22}^2 \pd{R_{22}}{{q}_{22}} \right]^T \lambda_{22} = & - hb_2 \left[\pd{f_{22}}{\ddot{q}_{22}} + ha_{22}\pd{f_{22}}{\dot{q}_{22}} + h^2a_{22}^2 \pd{f_{22}}{{q}_{22}} \right]^T \\ 
         & - hb_2  \psi_2 - hb_2 ha_{22}   \phi_2
       \end{split}
     \end{equation}

     % equation for lamda 21
     \begin{equation}
       \begin{split}
         hb_1\left[\pd{R_{21}}{\ddot{q}_{21}} + ha_{11}\pd{R_{21}}{\dot{q}_{21}} + h^2a_{11}^2 \pd{R_{21}}{{q}_{21}} \right]^T \lambda_{21} = & - hb_1 \left[\pd{f_{21}}{\ddot{q}_{21}} + ha_{11}\pd{f_{21}}{\dot{q}_{21}} + h^2a_{11}^2 \pd{f_{21}}{{q}_{21}} \right]^T \\ 
         & - hb_2 \left[ha_{21}\pd{f_{22}}{\dot{q}_{22}} + (ha_{21}ha_{11} + ha_{22}ha_{21}) \pd{f_{22}}{{q}_{22}} \right]^T \\
         & - hb_2 \left[ha_{21}\pd{R_{22}}{\dot{q}_{22}} + (ha_{21}ha_{11} + ha_{22}ha_{21}) \pd{R_{22}}{{q}_{22}} \right]^T\lambda_{22} \\
         & - hb_1 \psi_2  - (hb_1ha_{11} + hb_2ha_{21})  \phi_2
       \end{split}
     \end{equation}

     \subsection{Three-Staged DIRK}
     \paragraph{Time step $k=3$:}
     The state approximations for three-staged DIRK scheme are as follows.
     \begin{equation}\nonumber
       \begin{split}
         \dot{q}_{31} &= \dot{q}_2 + h a_{11} \ddot{q}_{31} \\
         \dot{q}_{32} &= \dot{q}_2 + h a_{21} \ddot{q}_{31} + h a_{22} \ddot{q}_{32} \\
         \dot{q}_{33} &= \dot{q}_2 + h a_{31} \ddot{q}_{31} + h a_{32} \ddot{q}_{32} + h a_{33} \ddot{q}_{33} \\
         \\
         q_{31} &= q_2 + h a_{11} \dot{q}_{31} \\
         q_{32} &= q_2 + h a_{21} \dot{q}_{31} + h a_{22} \dot{q}_{32} \\
         q_{33} &= q_2 + h a_{31} \dot{q}_{31} + h a_{32} \dot{q}_{32}+ h a_{33} \dot{q}_{33}  \\
       \end{split}
     \end{equation}
     
     \begin{table}[H]
       \centering
       \begin{tabular}{l | l  |l}
         $\lambda_{31}^T$ & $h b_1$ &  $\mathbf{R_{31}}\left(\underline{\mathbf{\ddot{q}_{31}}}, \mathbf{\dot{q}_{31}}(\dot{q_2},\ddot{q_{31}}),\mathbf{{q}_{31}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}))\right)$ \\
         $\lambda_{32}^T$ & $h b_2$  &  $\mathbf{R_{32}}\left(\underline{\mathbf{\ddot{q}_{32}}}, \mathbf{\dot{q}_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}),\mathbf{{q}_{32}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}),\dot{q_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}))\right)$ \\
         $\lambda_{33}^T$ & $ h b_3 $ & $\mathbf{R_{33}} \left(\underline{\mathbf{\ddot{q}_{33}}}, \mathbf{\dot{q}_{33}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}},\ddot{q_{33}}), \mathbf{{q}_{33}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}),\dot{q_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}),\dot{q_{33}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}},\ddot{q_{33}}))\right)$\\
         & $h b_1$ & $\mathbf{f_{31}}\left(\underline{\mathbf{\ddot{q}_{31}}}, \mathbf{\dot{q}_{31}}(\dot{q_2},\ddot{q_{31}}),\mathbf{{q}_{31}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}))\right)$ \\
         & $h b_2$ & $\mathbf{f_{32}}\left(\underline{\mathbf{\ddot{q}_{32}}}, \mathbf{\dot{q}_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}),\mathbf{{q}_{32}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}),\dot{q_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}))\right)$ \\
         & $h b_3$ &  $\mathbf{f_{33}}\left(\underline{\mathbf{\ddot{q}_{33}}}, \mathbf{\dot{q}_{33}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{33}},\ddot{q_{33}}), \mathbf{{q}_{32}}(q_2,\dot{q_{31}}(\dot{q_2},\ddot{q_{31}}),\dot{q_{32}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}}),\dot{q_{33}}(\dot{q_2},\ddot{q_{31}},\ddot{q_{32}},\ddot{q_{33}}))\right)$ \\
         $\phi_3^T$ & & $\mathbf{T_3}(q_2 + h b_1 \dot{q}_{31}(\dot{q}_2,\ddot{q_{31}}) +  h b_2 \dot{q}_{32}(\dot{q}_2,\ddot{q_{31}},\ddot{q_{32}}) +  h b_3 \dot{q}_{33}(\dot{q}_2,\ddot{q_{31}},\ddot{q_{32}},\ddot{q_{33}}) - \underline{\mathbf{q_3}} )$\\
         $\psi_3^T$ & & $\mathbf{S_3}(\dot{q}_2 + h b_1 \ddot{q}_{31} +  h b_2 \ddot{q}_{32}  +  h b_3 \ddot{q}_{33} - \underline{\mathbf{\dot{q}_3}} )$ \\
       \end{tabular}
     \end{table}

     The adjoint variables at this step are
     $\psi_3,\phi_3,\lambda_{31},\lambda_{32},\lambda_{33}$.
     \begin{table}[h]
       \centering
       \begin{tabular}{l|l}
         $\pd{{\mathcal L}}{{q}_{3}}  = 0$      & $\pd{T_3}{q_3}^T \phi_3 = 0$ \\
         &\\
         $\pd{{\mathcal L}}{\dot{q}_{3}}  = 0$  & $ \pd{{S_3}}{\dot{q}_{3}}^T \psi_3 = 0$  \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{33}} = 0$ & $hb_3\pd{R_{33}}{\ddot{q}_{33}}^T\lambda_{33} + \pd{T_3}{\ddot{q}_{33}}^T \phi_3 + \pd{S_3}{\ddot{q}_{33}}^T \psi_3 + hb_3\pd{f_{33}}{\ddot{q}_{33}}^T = 0$ \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{32}} = 0$ & $hb_2\pd{R_{32}}{\ddot{q}_{32}}^T\lambda_{32} + hb_3\pd{R_{33}}{\ddot{q}_{32}}^T\lambda_{33} + \pd{T_3}{\ddot{q}_{32}}^T \phi_3 + \pd{S_3}{\ddot{q}_{32}}^T \psi_3 + hb_2\pd{f_{32}}{\ddot{q}_{32}}^T + + hb_3\pd{f_{33}}{\ddot{q}_{32}}^T= 0$ \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{31}} = 0$ & $hb_1 \pd{R_{31}}{\ddot{q}_{31}}^T \lambda_{31} +  h b_2 \pd{R_{32}}{\ddot{q}_{31}}^T \lambda_{32} + h b_3 \pd{R_{33}}{\ddot{q}_{31}}^T \lambda_{33}  + \pd{S_3}{\ddot{q}_{31}}^T \psi_3 + \pd{T_3}{\ddot{q}_{31}}^T \phi_3 + $ \\ 
         & $ h b_1 \pd{f_{31}}{\ddot{q}_{31}}^T +  h b_2 \pd{f_{32}}{\ddot{q}_{31}}^T +  h b_3 \pd{f_{33}}{\ddot{q}_{31}}^T = 0  $ \\
       \end{tabular}
     \end{table}

     \begin{equation}
       \phi_3 = 0
     \end{equation}


          \begin{equation}
       \psi_3 = 0
     \end{equation}

     % equation for lamda 33
     \begin{equation}
       \begin{split}
         hb_3\left[\pd{R_{33}}{\ddot{q}_{33}} + ha_{33}\pd{R_{33}}{\dot{q}_{33}} + h^2a_{33}^2 \pd{R_{33}}{{q}_{33}} \right]^T \lambda_{33} = & - hb_3 \left[\pd{f_{33}}{\ddot{q}_{33}} + ha_{33}\pd{f_{33}}{\dot{q}_{33}} + h^2a_{33}^2 \pd{f_{33}}{{q}_{33}} \right]^T \\ 
         & - hb_3  \psi_3 \\ 
         & - hb_3ha_{33}   \phi_3
       \end{split}
     \end{equation}

     % equation for lamda 32
     \begin{equation}
       \begin{split}
         hb_2\left[\pd{R_{32}}{\ddot{q}_{32}} + ha_{22}\pd{R_{32}}{\dot{q}_{32}} + h^2a_{22}^2 \pd{R_{32}}{{q}_{32}} \right]^T \lambda_{32} = & - hb_2 \left[\pd{f_{32}}{\ddot{q}_{32}} + ha_{22}\pd{f_{32}}{\dot{q}_{32}} + h^2a_{22}^2 \pd{f_{32}}{{q}_{32}} \right]^T \\ 
         & - hb_3 \left[ha_{32}\pd{f_{33}}{\dot{q}_{33}} + (ha_{32}ha_{22} + ha_{33}ha_{32}) \pd{f_{33}}{{q}_{33}} \right]^T \\  
         & - hb_3 \left[ha_{32}\pd{R_{33}}{\dot{q}_{33}} + (ha_{32}ha_{22} + ha_{33}ha_{32}) \pd{R_{33}}{{q}_{33}} \right]^T\lambda_{33} \\  
         & - hb_2  \psi_3 \\ 
         & - (hb_2ha_{22} + hb_3 ha_{32})   \phi_3
       \end{split}
     \end{equation}

     % equation for lamda 31
     \begin{equation}
       \begin{split}
         hb_1\left[\pd{R_{31}}{\ddot{q}_{31}} + ha_{11}\pd{R_{31}}{\dot{q}_{31}} + h^2a_{11}^2 \pd{R_{31}}{{q}_{31}} \right]^T \lambda_{31} = & - hb_1 \left[\pd{f_{31}}{\ddot{q}_{31}} + ha_{11}\pd{f_{31}}{\dot{q}_{31}} + h^2a_{11}^2 \pd{f_{31}}{{q}_{31}} \right]^T \\ 
         & - hb_2 \left[ ha_{21} \pd{R_{32}}{\dot{q}_{32}} + (ha_{21}ha_{11} + ha_{22}ha_{21}) \pd{R_{32}}{{q}_{32}} \right]\lambda_{32} \\
         & - hb_2 \left[ ha_{21} \pd{f_{32}}{\dot{q}_{32}} + (ha_{21}ha_{11} + ha_{22}ha_{21}) \pd{f_{32}}{{q}_{32}} \right] \\
         & - hb_3 \left[ ha_{31} \pd{R_{33}}{\dot{q}_{33}} + (ha_{31}ha_{11} + ha_{32}ha_{21} + ha_{33}ha_{31}) \pd{R_{33}}{{q}_{33}} \right] \lambda_{33} \\
         & - hb_3 \left[ ha_{31} \pd{f_{33}}{\dot{q}_{33}} + (ha_{31}ha_{11} + ha_{32}ha_{21} + ha_{33}ha_{31}) \pd{f_{33}}{{q}_{33}} \right] \\
         & - hb_1 \psi_3 \\ 
         & - (hb_1ha_{11} + hb_2ha_{21}+ hb_3ha_{31})  \phi_3
       \end{split}
     \end{equation}

     % Tecond step
     \paragraph{Time step $k=2$:}
     The state approximations at this step are as follows.
     \begin{equation}\nonumber
       \begin{split}
         \dot{q}_{21} &= \dot{q}_1 + h a_{11} \ddot{q}_{21} \\
         \dot{q}_{22} &= \dot{q}_1 + h a_{21} \ddot{q}_{21} + h a_{22} \ddot{q}_{22} \\
         \dot{q}_{23} &= \dot{q}_1 + h a_{31} \ddot{q}_{21} + h a_{32} \ddot{q}_{22} + h a_{33} \ddot{q}_{23} \\
         \\
         q_{21} &= q_1 + h a_{11} \dot{q}_{21} \\
         q_{22} &= q_1 + h a_{21} \dot{q}_{21} + h a_{22} \dot{q}_{22} \\
         q_{23} &= q_1 + h a_{31} \dot{q}_{21} + h a_{32} \dot{q}_{22} + h a_{33} \dot{q}_{23}
       \end{split}
     \end{equation}

     The equations and the associated adjoint variables are shown here.
     \begin{table}[H]
       \centering
       \begin{tabular}{l|l|l}
         $\lambda_{21}^T$ & $h b_1$ & $\mathbf{R_{21}}\left(\underline{\mathbf{\ddot{q}_{21}}},\mathbf{\dot{q}_{21}}(\dot{q_1},\ddot{q_{21}}),\mathbf{{q}_{21}}({q_1},\dot{q_{21}}(\dot{q_1},\ddot{q_{21}}))\right)$\\
         $\lambda_{22}^T$ & $h b_2$ & $\mathbf{R_{22}}\left(\underline{\mathbf{\ddot{q}_{22}}},\mathbf{\dot{q}_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}),\mathbf{{q}_{22}}({q_1},\dot{q_{21}}(\dot{q_1},\ddot{q_{21}}),\dot{q_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}))\right)$\\
         $\lambda_{23}^T$ & $h b_3$ & $\mathbf{R_{23}}\left(\underline{\mathbf{\ddot{q}_{23}}},\mathbf{\dot{q}_{23}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}},\ddot{q_{23}}),\mathbf{{q}_{23}}({q_1},\dot{q_{21}}(\dot{q_1},\ddot{q_{21}}),\dot{q_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}),\dot{q_{23}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}},\ddot{q_{23}}))\right)$ \\
         & $h b_1$ &$\mathbf{f_{21}}\left(\underline{\mathbf{\ddot{q}_{21}}},\mathbf{\dot{q}_{21}}(\dot{q_1},\ddot{q_{21}}),\mathbf{{q}_{21}}({q_1},\dot{q_{21}}(q_1,\ddot{q_{21}}))\right)$ \\
         & $h b_2$ &$\mathbf{f_{22}}\left(\underline{\mathbf{\ddot{q}_{22}}},\mathbf{\dot{q}_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}),\mathbf{{q}_{22}}({q_1},\dot{q_{21}}(\dot{q_1},\ddot{q_{21}}),\dot{q_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}))\right)$ \\
         & $h b_3$ &$\mathbf{f_{23}}\left(\underline{\mathbf{\ddot{q}_{23}}},\mathbf{\dot{q}_{23}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}},\ddot{q_{23}}),\mathbf{{q}_{23}}({q_1},\dot{q_{21}}(\dot{q_1},\ddot{q_{21}}),\dot{q_{22}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}),\dot{q_{23}}(\dot{q_1},\ddot{q_{21}},\ddot{q_{22}},\ddot{q_{23}}))\right)$ \\
         $\psi_2^T$ &&$\mathbf{S_2}\left(\dot{q}_1 + h b_1 \ddot{q}_{21} +  h b_2 \ddot{q}_{22} +  h b_2 \ddot{q}_{23} - \underline{\mathbf{\dot{q}_2}} \right)$ \\
         $\phi_2^T$ &&$\mathbf{T_2}\left(q_1 + h b_1 \dot{q}_{21}(\dot{q_1},\ddot{q_{21}}) +  h b_2 \dot{q}_{22} (\dot{q_1},\ddot{q_{21}},\ddot{q_{22}}) +  h b_3 \dot{q}_{23} (\dot{q_1},\ddot{q_{21}},\ddot{q_{22}},\ddot{q_{23}}) - \underline{\mathbf{q_2}} \right)$ \\
       \end{tabular}
     \end{table}
     
     The adjoint variables at this time step are
     $\psi_2,\phi_2,\lambda_{31},\lambda_{32},\lambda_{33}$.
     \begin{table}[H]
       \centering
       \begin{tabular}{c|l}
         $\pd{{\mathcal L}}{{q}_{2}}       = 0$ & $\pd{T_2}{q_2}^T \phi_2 + hb_1\pd{R_{31}}{q_2}^T\lambda_{31} + hb_2\pd{R_{32}}{q_2}^T \lambda_{32} + hb_3\pd{R_{33}}{q_2}^T \lambda_{33}$\\ 
         &$  + hb_1\pd{f_{31}}{q_2}^T + hb_2\pd{f_{32}}{q_2}^T + hb_3\pd{f_{33}}{q_2}^T + \pd{T_3}{q_2}^T \phi_3  = 0$ \\
         &\\
                  $\pd{{\mathcal L}}{\dot{q}_{2}}   = 0$ & $\pd{{S_2}}{\dot{q}_{2}}^T \psi_2 + h b_1 \pd{R_{31}}{\dot{q}_2}^T\lambda_{31} +  hb_2 \pd{R_{32}}{\dot{q}_2}^T \lambda_{32}  +  hb_3 \pd{R_{33}}{\dot{q}_2}^T \lambda_{33}$ \\
         & $ + h b_1 \pd{f_{31}}{\dot{q}_2}^T + h b_2 \pd{f_{32}}{\dot{q}_2}^T + h b_3 \pd{f_{33}}{\dot{q}_2}^T + \pd{T_3}{\dot{q}_2}^T \phi_3 + \pd{S_3}{\dot{q}_2}^T \psi_3 = 0$  \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{23}} = 0$ & $hb_3\pd{R_{23}}{\ddot{q}_{23}}^T\lambda_{23} + \pd{T_2}{\ddot{q}_{23}}^T \phi_2 + \pd{S_2}{\ddot{q}_{23}}^T \psi_2 + hb_3\pd{f_{23}}{\ddot{q}_{23}}^T = 0$ \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{22}} = 0$ & $hb_2\pd{R_{22}}{\ddot{q}_{22}}^T\lambda_{22} + hb_3\pd{R_{23}}{\ddot{q}_{22}}^T\lambda_{23} + \pd{T_3}{\ddot{q}_{22}}^T \phi_3 + \pd{S_3}{\ddot{q}_{22}}^T \psi_3 + hb_2\pd{f_{22}}{\ddot{q}_{22}}^T + + hb_3\pd{f_{23}}{\ddot{q}_{22}}^T= 0$ \\
         &\\
         $\pd{{\mathcal L}}{\ddot{q}_{21}} = 0$ & $hb_1 \pd{R_{21}}{\ddot{q}_{21}}^T \lambda_{21} +  h b_2 \pd{R_{22}}{\ddot{q}_{21}}^T \lambda_{22} + h b_3 \pd{R_{23}}{\ddot{q}_{21}}^T \lambda_{23}  + \pd{S_3}{\ddot{q}_{21}}^T \psi_3 + \pd{T_3}{\ddot{q}_{21}}^T \phi_3 + $ \\ 
         & $ h b_1 \pd{f_{21}}{\ddot{q}_{21}}^T +  h b_2 \pd{f_{22}}{\ddot{q}_{21}}^T +  h b_3 \pd{f_{23}}{\ddot{q}_{21}}^T = 0  $ \\
       \end{tabular}
     \end{table}

     % equation for phi2
     \begin{equation}
       \begin{split}
          \phi_2 =  \phi_3 + hb_1 \pd{R_{31}}{q_{31}}^T \lambda_{31} + hb_1 \pd{f_{31}}{q_{31}}^T + hb_2 \pd{R_{32}}{q_{32}}^T \lambda_{32} + hb_2 \pd{f_{32}}{q_{32}}^T + hb_3 \pd{R_{33}}{q_{33}}^T \lambda_{33} + hb_3 \pd{f_{33}}{q_{33}}^T \\
       \end{split}
     \end{equation}
     
     % equation for psi2
     \begin{equation}
       \begin{split}
          \psi_2 =  & \psi_3 + (hb_1 + hb_2 + hb_3)  \phi_3  \\ 
         & + hb_1 \left[ \pd{R_{31}}{\dot{q}_{31}} + ha_{11} \pd{R_{31}}{q_{31}}  \right]^T \lambda_{31} + hb_1 \left[ \pd{f_{31}}{\dot{q}_{31}} + ha_{11} \pd{f_{31}}{{q}_{31}} \right]^T \\
         & + hb_2 \left[ \pd{R_{32}}{\dot{q_{32}}} + (ha_{21} + ha_{22}) \pd{R_{32}}{q_{32}} \right]^T \lambda_{32} + hb_2 \left[ \pd{f_{32}}{\dot{q_{32}}} + (ha_{21} + ha_{22}) \pd{f_{32}}{q_{32}} \right]^T \\               
         & + hb_3 \left[ \pd{R_{33}}{\dot{q_{33}}} + (ha_{31} + ha_{32} + ha_{33}) \pd{R_{33}}{q_{33}} \right]^T \lambda_{33} + hb_3 \left[ \pd{f_{33}}{\dot{q_{33}}} + (ha_{31} + ha_{32} + ha_{33}) \pd{f_{33}}{q_{33}} \right]^T
       \end{split}
     \end{equation}


     % equation for lamda 23
     \begin{equation}
       \begin{split}
         hb_3\left[\pd{R_{23}}{\ddot{q}_{23}} + ha_{33}\pd{R_{23}}{\dot{q}_{23}} + h^2a_{33}^2 \pd{R_{23}}{{q}_{23}} \right]^T \lambda_{23} = & - hb_3 \left[\pd{f_{23}}{\ddot{q}_{23}} + ha_{33}\pd{f_{23}}{\dot{q}_{23}} + h^2a_{33}^2 \pd{f_{23}}{{q}_{23}} \right]^T \\ 
         & - hb_3 \psi_2 \\ 
         & - hb_3ha_{33}   \phi_2
       \end{split}
     \end{equation}

     % equation for lamda 22
     \begin{equation}
       \begin{split}
         hb_2\left[\pd{R_{22}}{\ddot{q}_{22}} + ha_{22}\pd{R_{22}}{\dot{q}_{22}} + h^2a_{22}^2 \pd{R_{22}}{{q}_{22}} \right]^T \lambda_{22} = & - hb_2 \left[\pd{f_{22}}{\ddot{q}_{22}} + ha_{22}\pd{f_{22}}{\dot{q}_{22}} + h^2a_{22}^2 \pd{f_{22}}{{q}_{22}} \right]^T \\ 
         & - hb_3 \left[ha_{32}\pd{f_{23}}{\dot{q}_{23}} + (ha_{32}ha_{22} + ha_{33}ha_{32}) \pd{f_{23}}{{q}_{23}} \right]^T \\  
         & - hb_3 \left[ha_{32}\pd{R_{23}}{\dot{q}_{23}} + (ha_{32}ha_{22} + ha_{33}ha_{32}) \pd{R_{23}}{{q}_{23}} \right]^T\lambda_{23} \\  
         & - hb_2  \psi_2 \\ 
         & - (hb_2ha_{22} + hb_3 ha_{32})   \phi_2
       \end{split}
     \end{equation}

     % equation for lamda 21
     \begin{equation}
       \begin{split}
         hb_1\left[\pd{R_{21}}{\ddot{q}_{21}} + ha_{11}\pd{R_{21}}{\dot{q}_{21}} + h^2a_{11}^2 \pd{R_{21}}{{q}_{21}} \right]^T \lambda_{21} = & - hb_1 \left[\pd{f_{21}}{\ddot{q}_{21}} + ha_{11}\pd{f_{21}}{\dot{q}_{21}} + h^2a_{11}^2 \pd{f_{21}}{{q}_{21}} \right]^T \\ 
         & - hb_2 \left[ ha_{21} \pd{R_{22}}{\dot{q}_{22}} + (ha_{21}ha_{11} + ha_{22}ha_{21}) \pd{R_{22}}{{q}_{22}} \right]\lambda_{22} \\
         & - hb_2 \left[ ha_{21} \pd{f_{22}}{\dot{q}_{22}} + (ha_{21}ha_{11} + ha_{22}ha_{21}) \pd{f_{22}}{{q}_{22}} \right] \\
         & - hb_3 \left[ ha_{31} \pd{R_{23}}{\dot{q}_{23}} + (ha_{31}ha_{11} + ha_{32}ha_{21} + ha_{33}ha_{31}) \pd{R_{23}}{{q}_{23}} \right] \lambda_{23} \\
         & - hb_3 \left[ ha_{31} \pd{f_{23}}{\dot{q}_{23}} + (ha_{31}ha_{11} + ha_{32}ha_{21} + ha_{33}ha_{31}) \pd{f_{23}}{{q}_{23}} \right] \\
         & - hb_1 \psi_2 \\ 
         & - (hb_1ha_{11} + hb_2ha_{21}+ hb_3ha_{31})  \phi_2
       \end{split}
     \end{equation}


     \paragraph{General DIRK Adjoint Relations:}
     We introduce $\lambda$, $\phi$ and $\psi$ as adjoint variables associated with equations $R$, $T$ and $S$. The Lagrangian is
     $$ {\cal{L}} = \sum_{k=2}^{N} \sum_{i=1}^s h b_i f_{ki}  +  \sum_{k=2}^{N} \sum_{i=1}^s\lambda_{ki}^T  h b_i R_{ki}   + \sum_{k=1}^N \phi_k^T T_k + \sum_{k=1}^N \psi_k^T S_k. $$

     
     \paragraph{Position adjoint:}
     

     \begin{equation}\nonumber
       \phi_k = \phi_{k+1} + h \sum_{i=1}^s b_i \left[ \pd{R_{k+1,i}}{q_{k+1,i}} \right]^T \lambda_{k+1,i} + h \sum_{i=1}^s b_i \left[ \pd{f_{k+1,i}}{q_{k+1,i}} \right]^T
     \end{equation}
     Here, $$ \alpha = hb_i, \beta = 0, \gamma = 0$$
     

     \paragraph{Velocity adjoint:}

     \begin{equation}\nonumber
       \begin{split}
         \psi_k =  \psi_{k+1} + \left(h\sum_{i=1}^s b_i\right)
         \phi_{k+1} & + h \sum_{i=1}^sb_i
         \left[\pd{R_{k+1,i}}{\dot{q}_{k+1,i}} + \left( h \sum_{j=1}^i
           a_{ij} \right) \pd{R_{k+1,i}}{q_{k+1,i}} \right]^T
         \lambda_{k+1,i} \\ & + h \sum_{i=1}^sb_i
         \left[\pd{f_{k+1,i}}{\dot{q}_{k+1,i}} + \left( h \sum_{j=1}^i
           a_{ij} \right) \pd{f_{k+1,i}}{q_{k+1,i}} \right]^T
       \end{split}
     \end{equation}
     Noting that $\sum_{i=1}^s b_i = 1$, and $\sum_{j=1}^i a_{ij} = c_i$,
     \begin{equation}\nonumber
       \begin{split}
         \psi_k =  \psi_{k+1} + h \phi_{k+1}  & + h \sum_{i=1}^sb_i \left[\pd{R_{k+1,i}}{\dot{q}_{k+1,i}} + hc_i \pd{R_{k+1,i}}{q_{k+1,i}} \right]^T \lambda_{k+1,i}  \\ &+ h \sum_{i=1}^sb_i \left[\pd{f_{k+1,i}}{\dot{q}_{k+1,i}} +hc_i \pd{f_{k+1,i}}{q_{k+1,i}} \right]^T
       \end{split}
     \end{equation}
     Therefore  $$\beta = hb_i, \alpha = \beta hc_i, \gamma = 0.$$
     \paragraph{Primary adjoint:}
     Taking $\partial{\cal{L}}/\partial{\ddot{q}_{ki}}$ = 0 yields
     \begin{equation}\nonumber
       \begin{split}
         0 & = hb_i \pd{f_{ki}}{\ddot{q}_{ki}} + \sum_{j=i}^s b_j \left[ ha_{ji} \pd{f_{kj}}{\dot{q}_{kj}} 
           + h^2 (\sum_{p=i}^j a_{jp}a_{pi}) 
           \pd{f_{kj}}{{q}_{kj}} \right]^T \\
         &  + hb_i \pd{R_{ki}}{\ddot{q}_{ki}} + \sum_{j=i}^s b_j \left[ ha_{ji} \pd{R_{kj}}{\dot{q}_{kj}} 
           + h^2 (\sum_{p=i}^j a_{jp}a_{pi}) 
           \pd{R_{kj}}{{q}_{kj}} \right]^T \lambda_{kj} \\ 
         &  + \sum_{j=i}^s h b_j h a_{ji} \phi_{k}  \\
         &  +  h b_i \psi_{k} \\
       \end{split}
     \end{equation}
     Note the similarities in the terms arising from the governing
     equation and the function.
     \begin{equation}\nonumber
       \begin{split}
         b_i \left[ \pd{R_{ki}}{\ddot{q}_{ki}} + ha_{ii} \pd{R_{ki}}{\dot{q}_{ki}} + h^2 a_{ii}^2 \pd{R_{ki}}{{q}_{ki}} \right]^T \lambda_{ki} = & - b_i \left[ \pd{f_{ki}}{\ddot{q}_{ki}} + h^2a_{ii}^2 \pd{f_{ki}}{\dot{q}_{ki}} + h^2a_{ii}^2 \pd{f_{ki}}{{q}_{ki}} \right]^T \\
         & - \sum_{j=i+1}^s b_j \left[ ha_{ji} \pd{R_{kj}}{\dot{q}_{kj}} 
           + h^2 (\sum_{p=i}^j a_{jp}a_{pi}) 
           \pd{R_{kj}}{{q}_{kj}} \right]^T \lambda_{kj} \\
         & -  \sum_{j=i+1}^s b_j \left[ ha_{ji} \pd{f_{kj}}{\dot{q}_{kj}} 
           + h^2 (\sum_{p=i}^j a_{jp}a_{pi}) 
           \pd{f_{kj}}{{q}_{kj}} \right]^T  \\
         & -   (\sum_{j=i}^s h b_j a_{ji}) \phi_{k}  \\
         &  - b_i \psi_{k} 
       \end{split}
     \end{equation}
     

\end{document}
%     \chapter{Continuous Adjoint Formulations}
%     \part{Direct Sensitivities}

s-t
t-s
phi-psi
psi-phi
